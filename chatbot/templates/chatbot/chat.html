{% load static %}
<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Assistant LIASEC</title>

    <link rel="stylesheet" href="{% static 'chatbot/css/chat.css' %}">
    <link rel="stylesheet" href="{% static 'chatbot/css/keyboard.css' %}">
    <link rel="icon" href="{% static 'chatbot/images/logo.png' %}" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <meta name="description"
          content="Assistant virtuel LIASEC — Chat interactif, reconnaissance vocale et synthèse vocale.">

    <style>
      .chat-home-btn {
        position: fixed;
        top: 16px;
        right: 16px;
        width: 72px;
        height: 72px;
        border-radius: 999px;
        border: none;
        background: #2563eb;
        color: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 10px 25px rgba(37, 99, 235, 0.45);
        cursor: pointer;
        z-index: 50;
        font-size: 32px;
      }

      .chat-home-btn img {
        width: 36px;
        height: 36px;
      }
    </style>
  </head>

  <body class="chatbody">
    <!-- Son ON/OFF -->
    <button
      type="button"
      class="btn icon chat-sound"
      id="soundToggle"
      title="Activer/Désactiver la voix"
    >
      <img src="{% static 'chatbot/images/icons/volume.svg' %}"
           alt="Activer/Désactiver la voix" />
    </button>

    <!-- Bouton Home -->
    <button
      type="button"
      class="btn icon chat-home-btn"
      id="chatHomeButton"
      title="Retour à l'accueil"
    >
      <i class="bi bi-house-fill" aria-hidden="true"></i>
    </button>

    <main class="chat-container">
      <section id="messages" class="messages"></section>

      <footer class="composer">
        <form id="chatForm" class="composer-form" autocomplete="off">
          <div class="composer-inner">
            <div class="composer-input-wrap">
              <span class="input-icon">
                <img src="{% static 'chatbot/images/icons/keyboard.svg' %}" alt="Clavier" />
              </span>
              <input
                id="chat-form-input"
                type="text"
                placeholder="Écrire un message…"
                aria-label="Message"
              />
            </div>

            <div class="composer-actions">
              <button
                type="button"
                class="btn icon chat-mic"
                title="Appuyer pour parler"
              >
                <img src="{% static 'chatbot/images/icons/mic.svg' %}" alt="Micro" />
              </button>

              <button
                type="button"
                class="btn icon chat-reset"
                title="Réinitialiser la conversation"
              >
                <img src="{% static 'chatbot/images/icons/reset.svg' %}" alt="Reset" />
              </button>

              <button
                type="button"
                class="btn icon primary chat-send"
                title="Envoyer le message"
              >
                <img src="{% static 'chatbot/images/icons/send.png' %}" alt="Envoyer" />
              </button>
            </div>
          </div>
        </form>
      </footer>

      <div id="virtualKeyboard" class="keyboard"></div>

      <div id="svgModal" role="dialog" aria-modal="true">
        <div class="map-modal-content">
          <button
            type="button"
            id="closeMapBtn"
            class="map-modal-close"
            aria-label="Fermer la carte"
          >
            &times;
          </button>

          <h2 class="map-modal-title">Localiser le produit</h2>

          <object
            id="svgMap"
            type="image/svg+xml"
            data="{% static 'chatbot/svg/carte_sport.svg' %}"
            class="map-svg"
          ></object>
        </div>
      </div>
    </main>

    <!-- Pop-up confirmation retour accueil -->
    <div id="homeConfirm" class="reset-popup" style="display: none;">
      <div class="reset-content">
        <h3>Voulez-vous retourner à l'accueil ?</h3>
        <div class="popup-buttons">
          <button type="button" class="button button-secondary" id="homeCancel">
            Non
          </button>
          <button type="button" class="button button-primary" id="homeConfirmYes">
            Oui
          </button>
        </div>
      </div>
    </div>

    <script>
      window.CHAT_API_URL = "{% url 'chatbot:chat_api' %}";
      window.FEEDBACK_URL = "{% url 'chatbot:feedback_api' %}";
      window.RESET_URL = "{% url 'chatbot:reset_chat' %}";
      window.INDEX_URL = "{% url 'chatbot:chatbot_index' %}";
    </script>

    <script src="{% static 'chatbot/js/sport.js' %}"></script>
    <script type="module" src="{% static 'chatbot/js/main.js' %}"></script>
    <script src="{% static 'chatbot/js/keyboard.js' %}"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Reset si F5 / actualisation
        if (performance && performance.navigation.type === 1) {
          fetch(window.RESET_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          }).then(() => {
            console.log("Conversation réinitialisée (F5)");
          });
        }

        // Gestion bouton Home + pop-up
        const homeBtn = document.getElementById("chatHomeButton");
        const modal = document.getElementById("homeConfirm");
        const btnNo = document.getElementById("homeCancel");
        const btnYes = document.getElementById("homeConfirmYes");

        if (homeBtn && modal && btnNo && btnYes) {
          homeBtn.addEventListener("click", () => {
            modal.style.display = "flex";
          });

          btnNo.addEventListener("click", () => {
            modal.style.display = "none";
          });

          btnYes.addEventListener("click", async () => {
            try {
              await fetch(window.RESET_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
              });
            } catch (e) {
              console.error("Erreur reset avant retour accueil (chat):", e);
            }
            window.location.href = window.INDEX_URL || "/";
          });
        }
      });
    </script>
  </body>
</html>
