{% load static %}
<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Assistant LIASEC</title>

    <link rel="stylesheet" href="{% static 'chatbot/css/chat.css' %}">
    <link rel="stylesheet" href="{% static 'chatbot/css/keyboard.css' %}">
    <link rel="icon" href="{% static 'chatbot/images/logo.png' %}" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <meta name="description"
          content="Assistant virtuel LIASEC — Chat interactif, reconnaissance vocale et synthèse vocale.">

    <style>
      .chat-home-btn {
        position: fixed;
        top: 16px;
        right: 16px;
        width: 90px;
        height: 90px;
        border-radius: 999px;
        border: none;
        background: linear-gradient(135deg, var(--decathlon-blue) 0%, var(--decathlon-purple) 100%);
        color: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 12px 35px rgba(37, 99, 235, 0.5);
        cursor: pointer;
        z-index: 1000;
        font-size: 40px;
      }

      .chat-home-btn img {
        width: 44px;
        height: 44px;
      }
    </style>
  </head>

  <body class="chatbody">
    <!-- Bouton Home -->
    <button
      type="button"
      class="btn icon chat-home-btn"
      id="chatHomeButton"
      title="Retour à l'accueil"
    >
      <i class="bi bi-house-fill" aria-hidden="true"></i>
    </button>

    <!-- Bouton Son ON/OFF -->
    <button
      type="button"
      class="btn icon chat-sound-btn"
      id="soundToggle"
      title="Activer/Désactiver la voix"
    >
      <i class="bi bi-volume-up-fill" id="soundIcon"></i>
    </button>

    <!-- Bouton Paramètres Vocaux -->
    <button
      type="button"
      class="btn icon chat-settings-btn"
      id="voiceSettingsBtn"
      title="Paramètres vocaux"
    >
      <i class="bi bi-sliders2"></i>
    </button>

    <!-- Panneau simplifié de paramètres vocaux -->
    <div id="voiceSettingsPanel" class="voice-settings-panel">
      <div class="voice-settings-header">
        <h2><i class="bi bi-sliders2"></i> Paramètres Vocaux</h2>
        <button type="button" id="closeVoiceSettings" class="close-settings-btn">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <!-- Présets de vitesse (gros boutons tactiles) -->
      <div class="voice-presets">
        <h3><i class="bi bi-speedometer2"></i> Vitesse de lecture</h3>
        <div class="preset-buttons">
          <button type="button" class="preset-btn" data-speed="slow">
            <i class="bi bi-hourglass"></i>
            <span>LENT</span>
            <small>0.7x</small>
          </button>
          <button type="button" class="preset-btn active" data-speed="normal">
            <i class="bi bi-check-circle-fill"></i>
            <span>NORMAL</span>
            <small>1.0x</small>
          </button>
          <button type="button" class="preset-btn" data-speed="fast">
            <i class="bi bi-lightning-fill"></i>
            <span>RAPIDE</span>
            <small>1.3x</small>
          </button>
        </div>
      </div>

      <!-- Volume simple -->
      <div class="volume-control">
        <h3><i class="bi bi-volume-up-fill"></i> Volume</h3>
        <div class="volume-buttons">
          <button type="button" class="volume-btn" data-volume="low">
            <i class="bi bi-volume-down"></i>
            <span>Faible</span>
          </button>
          <button type="button" class="volume-btn active" data-volume="medium">
            <i class="bi bi-volume-up"></i>
            <span>Moyen</span>
          </button>
          <button type="button" class="volume-btn" data-volume="high">
            <i class="bi bi-volume-up-fill"></i>
            <span>Fort</span>
          </button>
        </div>
      </div>

      <!-- Test vocal -->
      <button type="button" id="testVoiceBtn" class="test-voice-btn">
        <i class="bi bi-play-circle-fill"></i>
        TESTER LA VOIX
      </button>
    </div>

    <!-- Overlay sombre -->
    <div id="voiceSettingsOverlay" class="voice-settings-overlay"></div>

    <main class="chat-container">
      <section id="messages" class="messages"></section>

      <footer class="composer">
        <form id="chatForm" class="composer-form" autocomplete="off">
          <div class="composer-inner">
            <div class="composer-input-wrap">
              <span class="input-icon">
                <img src="{% static 'chatbot/images/icons/keyboard.svg' %}" alt="Clavier" />
              </span>
              <input
                id="chat-form-input"
                type="text"
                placeholder="Écrire un message…"
                aria-label="Message"
              />
            </div>

            <div class="composer-actions">
              <button
                type="button"
                class="btn icon chat-mic"
                title="Maintenez appuyé pour parler"
              >
                <img src="{% static 'chatbot/images/icons/mic.svg' %}" alt="Micro" />
              </button>

              <button
                type="button"
                class="btn icon chat-reset"
                title="Réinitialiser la conversation"
              >
                <img src="{% static 'chatbot/images/icons/reset.svg' %}" alt="Reset" />
              </button>

              <button
                type="button"
                class="btn icon primary chat-send"
                title="Envoyer le message"
              >
                <img src="{% static 'chatbot/images/icons/send.png' %}" alt="Envoyer" />
              </button>
            </div>
          </div>
        </form>
      </footer>

      <div id="virtualKeyboard" class="keyboard"></div>

      <div id="svgModal" role="dialog" aria-modal="true">
        <div class="map-modal-content">
          <button
            type="button"
            id="closeMapBtn"
            class="map-modal-close"
            aria-label="Fermer la carte"
          >
            &times;
          </button>

          <h2 class="map-modal-title">Localiser le produit</h2>

          <object
            id="svgMap"
            type="image/svg+xml"
            data="{% static 'chatbot/svg/carte_sport.svg' %}"
            class="map-svg"
          ></object>
        </div>
      </div>
    </main>

    <!-- Pop-up confirmation retour accueil -->
    <div id="homeConfirm" class="reset-popup" style="display: none;">
      <div class="reset-content">
        <h3>Voulez-vous retourner à l'accueil ?</h3>
        <div class="popup-buttons">
          <button type="button" class="button button-secondary" id="homeCancel">
            Non
          </button>
          <button type="button" class="button button-primary" id="homeConfirmYes">
            Oui
          </button>
        </div>
      </div>
    </div>

    <script>
      window.CHAT_API_URL = "{% url 'chatbot:chat_api' %}";
      window.FEEDBACK_URL = "{% url 'chatbot:feedback_api' %}";
      window.TRACK_CLICK_URL = "{% url 'chatbot:track_click' %}";
      window.RESET_URL = "{% url 'chatbot:reset_chat' %}";
      window.INDEX_URL = "{% url 'chatbot:chatbot_index' %}";
    </script>

    <script src="{% static 'chatbot/js/sport.js' %}"></script>
    <script type="module" src="{% static 'chatbot/js/main.js' %}"></script>
    <script src="{% static 'chatbot/js/keyboard.js' %}"></script>

    <script type="module">
      import { setVolume, setRate, setPitch, setVoice, getAvailableVoices, speak, initializeDefaultVoice } from "{% static 'chatbot/js/speech.js' %}";
      import { STATE } from "{% static 'chatbot/js/config.js' %}";

      document.addEventListener("DOMContentLoaded", function () {
        // Reset si F5 / actualisation
        if (performance && performance.navigation.type === 1) {
          fetch(window.RESET_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          }).then(() => {
            console.log("Conversation réinitialisée (F5)");
          });
        }

        // Gestion bouton Home + pop-up
        const homeBtn = document.getElementById("chatHomeButton");
        const modal = document.getElementById("homeConfirm");
        const btnNo = document.getElementById("homeCancel");
        const btnYes = document.getElementById("homeConfirmYes");

        if (homeBtn && modal && btnNo && btnYes) {
          homeBtn.addEventListener("click", () => {
            modal.style.display = "flex";
          });

          btnNo.addEventListener("click", () => {
            modal.style.display = "none";
          });

          btnYes.addEventListener("click", async () => {
            try {
              await fetch(window.RESET_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
              });
            } catch (e) {
              console.error("Erreur reset avant retour accueil (chat):", e);
            }
            window.location.href = window.INDEX_URL || "/";
          });
        }

        // === GESTION DES PARAMÈTRES VOCAUX ===
        const voiceSettingsBtn = document.getElementById("voiceSettingsBtn");
        const voiceSettingsPanel = document.getElementById("voiceSettingsPanel");
        const voiceSettingsOverlay = document.getElementById("voiceSettingsOverlay");
        const closeVoiceSettings = document.getElementById("closeVoiceSettings");
        const soundToggle = document.getElementById("soundToggle");
        const soundIcon = document.getElementById("soundIcon");
        const testVoiceBtn = document.getElementById("testVoiceBtn");

        // Ouvrir le panneau
        if (voiceSettingsBtn) {
          voiceSettingsBtn.addEventListener("click", () => {
            voiceSettingsPanel.classList.add("active");
            voiceSettingsOverlay.classList.add("active");
          });
        }

        // Fermer le panneau
        function closePanel() {
          voiceSettingsPanel.classList.remove("active");
          voiceSettingsOverlay.classList.remove("active");
        }

        if (closeVoiceSettings) {
          closeVoiceSettings.addEventListener("click", closePanel);
        }

        if (voiceSettingsOverlay) {
          voiceSettingsOverlay.addEventListener("click", closePanel);
        }

        // Bouton Sound ON/OFF
        if (soundToggle) {
          soundToggle.addEventListener("click", () => {
            STATE.soundEnabled = !STATE.soundEnabled;
            STATE.voiceEnabled = STATE.soundEnabled;
            updateSoundButton();

            // Arrêter toute synthèse en cours si on désactive
            if (!STATE.soundEnabled && window.speechSynthesis) {
              window.speechSynthesis.cancel();
            }
          });
        }

        function updateSoundButton() {
          if (!soundToggle || !soundIcon) return;

          if (STATE.soundEnabled) {
            soundToggle.classList.remove("disabled");
            soundIcon.className = "bi bi-volume-up-fill";
          } else {
            soundToggle.classList.add("disabled");
            soundIcon.className = "bi bi-volume-mute-fill";
          }
        }

        // Preset Vitesse
        const speedPresets = {
          slow: 0.7,
          normal: 1.0,
          fast: 1.3
        };

        document.querySelectorAll(".preset-btn").forEach(btn => {
          btn.addEventListener("click", () => {
            const speed = btn.getAttribute("data-speed");
            if (speedPresets[speed]) {
              setRate(speedPresets[speed]);

              // Update active state
              document.querySelectorAll(".preset-btn").forEach(b => b.classList.remove("active"));
              btn.classList.add("active");
            }
          });
        });

        // Preset Volume
        const volumePresets = {
          low: 0.5,
          medium: 0.8,
          high: 1.0
        };

        document.querySelectorAll(".volume-btn").forEach(btn => {
          btn.addEventListener("click", () => {
            const volume = btn.getAttribute("data-volume");
            if (volumePresets[volume]) {
              setVolume(volumePresets[volume]);

              // Update active state
              document.querySelectorAll(".volume-btn").forEach(b => b.classList.remove("active"));
              btn.classList.add("active");
            }
          });
        });

        // Tester la voix
        if (testVoiceBtn) {
          testVoiceBtn.addEventListener("click", () => {
            speak("Bonjour, ceci est un test de la voix du chatbot.");
          });
        }

        // Initialiser le bouton sound au chargement
        updateSoundButton();
      });
    </script>
  </body>
</html>
