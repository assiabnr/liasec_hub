{% load static %}
<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Assistant LIASEC</title>

    <link rel="stylesheet" href="{% static 'chatbot/css/chat.css' %}">
    <link rel="stylesheet" href="{% static 'chatbot/css/keyboard.css' %}">
    <link rel="icon" href="{% static 'chatbot/images/logo.png' %}" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <meta name="description"
          content="Assistant virtuel LIASEC — Chat interactif, reconnaissance vocale et synthèse vocale.">

    <style>
      .chat-home-btn {
        position: fixed;
        top: 16px;
        right: 16px;
        width: 72px;
        height: 72px;
        border-radius: 999px;
        border: none;
        background: #2563eb;
        color: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 10px 25px rgba(37, 99, 235, 0.45);
        cursor: pointer;
        z-index: 50;
        font-size: 32px;
      }

      .chat-home-btn img {
        width: 36px;
        height: 36px;
      }
    </style>
  </head>

  <body class="chatbody">
    <!-- Son ON/OFF -->
    <button
      type="button"
      class="btn icon chat-sound"
      id="soundToggle"
      title="Activer/Désactiver la voix"
    >
      <img src="{% static 'chatbot/images/icons/volume.svg' %}"
           alt="Activer/Désactiver la voix" />
    </button>

    <!-- Bouton Paramètres Voix -->
    <button
      type="button"
      class="btn icon chat-voice-settings"
      id="voiceSettingsBtn"
      title="Paramètres de la voix"
      style="position: fixed; top: 110px; right: 16px; width: 72px; height: 72px; border-radius: 999px; border: none; background: #2563eb; color: #ffffff; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.45); cursor: pointer; z-index: 50; font-size: 32px;"
    >
      <i class="bi bi-sliders" aria-hidden="true"></i>
    </button>

    <!-- Bouton Home -->
    <button
      type="button"
      class="btn icon chat-home-btn"
      id="chatHomeButton"
      title="Retour à l'accueil"
    >
      <i class="bi bi-house-fill" aria-hidden="true"></i>
    </button>

    <!-- Panneau des paramètres vocaux -->
    <div id="voiceSettingsPanel" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); z-index: 100; width: 90%; max-width: 500px;">
      <h3 style="margin: 0 0 20px 0; font-size: 24px; color: #1e293b;">Paramètres de la voix</h3>

      <!-- Volume -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #475569;">
          <i class="bi bi-volume-up"></i> Volume: <span id="volumeValue">100</span>%
        </label>
        <input type="range" id="volumeSlider" min="0" max="100" value="100" style="width: 100%; cursor: pointer;">
      </div>

      <!-- Vitesse -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #475569;">
          <i class="bi bi-speedometer2"></i> Vitesse: <span id="rateValue">1.0</span>x
        </label>
        <input type="range" id="rateSlider" min="0.5" max="2" step="0.1" value="1" style="width: 100%; cursor: pointer;">
      </div>

      <!-- Tonalité -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #475569;">
          <i class="bi bi-music-note-beamed"></i> Tonalité: <span id="pitchValue">1.0</span>
        </label>
        <input type="range" id="pitchSlider" min="0.5" max="2" step="0.1" value="1" style="width: 100%; cursor: pointer;">
      </div>

      <!-- Choix de la voix -->
      <div style="margin-bottom: 25px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #475569;">
          <i class="bi bi-person-voice"></i> Voix
        </label>
        <select id="voiceSelect" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e2e8f0; font-size: 16px; cursor: pointer;">
          <option value="">Voix par défaut</option>
        </select>
      </div>

      <div style="display: flex; gap: 10px;">
        <button type="button" id="testVoiceBtn" style="flex: 1; padding: 12px; background: #2563eb; color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 16px;">
          <i class="bi bi-play-fill"></i> Tester
        </button>
        <button type="button" id="closeVoiceSettings" style="flex: 1; padding: 12px; background: #64748b; color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 16px;">
          Fermer
        </button>
      </div>
    </div>

    <!-- Overlay sombre -->
    <div id="voiceSettingsOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 99;"></div>

    <main class="chat-container">
      <section id="messages" class="messages"></section>

      <footer class="composer">
        <form id="chatForm" class="composer-form" autocomplete="off">
          <div class="composer-inner">
            <div class="composer-input-wrap">
              <span class="input-icon">
                <img src="{% static 'chatbot/images/icons/keyboard.svg' %}" alt="Clavier" />
              </span>
              <input
                id="chat-form-input"
                type="text"
                placeholder="Écrire un message…"
                aria-label="Message"
              />
            </div>

            <div class="composer-actions">
              <button
                type="button"
                class="btn icon chat-mic"
                title="Appuyer pour parler"
              >
                <img src="{% static 'chatbot/images/icons/mic.svg' %}" alt="Micro" />
              </button>

              <button
                type="button"
                class="btn icon chat-reset"
                title="Réinitialiser la conversation"
              >
                <img src="{% static 'chatbot/images/icons/reset.svg' %}" alt="Reset" />
              </button>

              <button
                type="button"
                class="btn icon primary chat-send"
                title="Envoyer le message"
              >
                <img src="{% static 'chatbot/images/icons/send.png' %}" alt="Envoyer" />
              </button>
            </div>
          </div>
        </form>
      </footer>

      <div id="virtualKeyboard" class="keyboard"></div>

      <div id="svgModal" role="dialog" aria-modal="true">
        <div class="map-modal-content">
          <button
            type="button"
            id="closeMapBtn"
            class="map-modal-close"
            aria-label="Fermer la carte"
          >
            &times;
          </button>

          <h2 class="map-modal-title">Localiser le produit</h2>

          <object
            id="svgMap"
            type="image/svg+xml"
            data="{% static 'chatbot/svg/carte_sport.svg' %}"
            class="map-svg"
          ></object>
        </div>
      </div>
    </main>

    <!-- Pop-up confirmation retour accueil -->
    <div id="homeConfirm" class="reset-popup" style="display: none;">
      <div class="reset-content">
        <h3>Voulez-vous retourner à l'accueil ?</h3>
        <div class="popup-buttons">
          <button type="button" class="button button-secondary" id="homeCancel">
            Non
          </button>
          <button type="button" class="button button-primary" id="homeConfirmYes">
            Oui
          </button>
        </div>
      </div>
    </div>

    <script>
      window.CHAT_API_URL = "{% url 'chatbot:chat_api' %}";
      window.FEEDBACK_URL = "{% url 'chatbot:feedback_api' %}";
      window.TRACK_CLICK_URL = "{% url 'chatbot:track_click' %}";
      window.RESET_URL = "{% url 'chatbot:reset_chat' %}";
      window.INDEX_URL = "{% url 'chatbot:chatbot_index' %}";
    </script>

    <script src="{% static 'chatbot/js/sport.js' %}"></script>
    <script type="module" src="{% static 'chatbot/js/main.js' %}"></script>
    <script src="{% static 'chatbot/js/keyboard.js' %}"></script>

    <script type="module">
      import { setVolume, setRate, setPitch, setVoice, getAvailableVoices, speak, initializeDefaultVoice } from "{% static 'chatbot/js/speech.js' %}";

      document.addEventListener("DOMContentLoaded", function () {
        // Reset si F5 / actualisation
        if (performance && performance.navigation.type === 1) {
          fetch(window.RESET_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          }).then(() => {
            console.log("Conversation réinitialisée (F5)");
          });
        }

        // Gestion bouton Home + pop-up
        const homeBtn = document.getElementById("chatHomeButton");
        const modal = document.getElementById("homeConfirm");
        const btnNo = document.getElementById("homeCancel");
        const btnYes = document.getElementById("homeConfirmYes");

        if (homeBtn && modal && btnNo && btnYes) {
          homeBtn.addEventListener("click", () => {
            modal.style.display = "flex";
          });

          btnNo.addEventListener("click", () => {
            modal.style.display = "none";
          });

          btnYes.addEventListener("click", async () => {
            try {
              await fetch(window.RESET_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
              });
            } catch (e) {
              console.error("Erreur reset avant retour accueil (chat):", e);
            }
            window.location.href = window.INDEX_URL || "/";
          });
        }

        // === GESTION DES PARAMÈTRES VOCAUX ===
        const voiceSettingsBtn = document.getElementById("voiceSettingsBtn");
        const voiceSettingsPanel = document.getElementById("voiceSettingsPanel");
        const voiceSettingsOverlay = document.getElementById("voiceSettingsOverlay");
        const closeVoiceSettings = document.getElementById("closeVoiceSettings");

        const volumeSlider = document.getElementById("volumeSlider");
        const volumeValue = document.getElementById("volumeValue");
        const rateSlider = document.getElementById("rateSlider");
        const rateValue = document.getElementById("rateValue");
        const pitchSlider = document.getElementById("pitchSlider");
        const pitchValue = document.getElementById("pitchValue");
        const voiceSelect = document.getElementById("voiceSelect");
        const testVoiceBtn = document.getElementById("testVoiceBtn");

        // Ouvrir le panneau
        voiceSettingsBtn.addEventListener("click", () => {
          voiceSettingsPanel.style.display = "block";
          voiceSettingsOverlay.style.display = "block";
          loadVoices();
        });

        // Fermer le panneau
        function closePanel() {
          voiceSettingsPanel.style.display = "none";
          voiceSettingsOverlay.style.display = "none";
        }
        closeVoiceSettings.addEventListener("click", closePanel);
        voiceSettingsOverlay.addEventListener("click", closePanel);

        // Charger les voix disponibles
        function loadVoices() {
          const voices = window.speechSynthesis.getVoices();
          const frenchVoices = voices.filter(v => v.lang.startsWith('fr'));

          // Noms féminins à exclure pour prioriser les voix masculines
          const feminineNames = ['hortense', 'julie', 'denise', 'marie', 'celine', 'amelie', 'lea', 'pauline'];

          // Trier : voix masculines en premier, puis féminines
          const sortedVoices = frenchVoices.sort((a, b) => {
            const aName = a.name.toLowerCase();
            const bName = b.name.toLowerCase();
            const aIsFeminine = feminineNames.some(name => aName.includes(name));
            const bIsFeminine = feminineNames.some(name => bName.includes(name));

            if (aIsFeminine && !bIsFeminine) return 1;
            if (!aIsFeminine && bIsFeminine) return -1;

            // Prioriser Gerard Online en premier
            const aIsGerardOnline = aName.includes('gerard') && aName.includes('online');
            const bIsGerardOnline = bName.includes('gerard') && bName.includes('online');
            if (aIsGerardOnline && !bIsGerardOnline) return -1;
            if (!aIsGerardOnline && bIsGerardOnline) return 1;

            // Puis prioriser les autres voix Online
            const aIsOnline = aName.includes('online');
            const bIsOnline = bName.includes('online');
            if (aIsOnline && !bIsOnline) return -1;
            if (!aIsOnline && bIsOnline) return 1;

            return 0;
          });

          voiceSelect.innerHTML = '<option value="">Voix par défaut</option>';
          let gerardIndex = -1;

          sortedVoices.forEach((voice, index) => {
            // Extraire le prénom et la région
            let displayName = voice.name;

            // Extraire le prénom (généralement après "Microsoft" ou "Google" etc.)
            const parts = voice.name.split(' ');
            let firstName = '';
            let region = '';

            // Chercher le prénom (généralement le dernier mot avant "Online" ou le dernier mot)
            if (voice.name.includes('Online')) {
              const beforeOnline = voice.name.split('Online')[0].trim();
              const words = beforeOnline.split(' ');
              firstName = words[words.length - 1];
              region = 'Online';
            } else {
              // Prendre le dernier mot comme prénom
              firstName = parts[parts.length - 1];
              // Extraire la région du lang (ex: fr-FR -> France, fr-CA -> Canada)
              const langParts = voice.lang.split('-');
              if (langParts.length > 1) {
                const countryCode = langParts[1];
                const regions = {
                  'FR': 'France',
                  'CA': 'Canada',
                  'BE': 'Belgique',
                  'CH': 'Suisse'
                };
                region = regions[countryCode] || countryCode;
              }
            }

            displayName = `${firstName}${region ? ' (' + region + ')' : ''}`;

            const option = document.createElement('option');
            option.value = index;
            option.textContent = displayName;
            voiceSelect.appendChild(option);

            // Chercher Gerard (Online ou autre voix masculine Gerard)
            const voiceLower = voice.name.toLowerCase();
            if (voiceLower.includes('gerard')) {
              // Priorité à Gerard Online
              if (voiceLower.includes('online') && gerardIndex === -1) {
                gerardIndex = index;
              } else if (gerardIndex === -1) {
                gerardIndex = index;
              }
            }
          });

          // Définir Gerard par défaut s'il existe
          if (gerardIndex !== -1) {
            voiceSelect.value = gerardIndex;
            setVoiceByIndex(sortedVoices, gerardIndex);
            console.log('Voix Gerard définie par défaut:', sortedVoices[gerardIndex].name);
          }
        }

        // Fonction helper pour définir la voix par index
        function setVoiceByIndex(sortedVoices, index) {
          if (index >= 0 && index < sortedVoices.length) {
            setVoice(sortedVoices[index]);
          }
        }

        // Charger les voix dans le sélecteur quand elles sont disponibles
        function loadVoicesIntoSelector() {
          loadVoices();
        }

        // Si les voix ne sont pas chargées, attendre
        if (window.speechSynthesis.getVoices().length === 0) {
          window.speechSynthesis.addEventListener('voiceschanged', loadVoicesIntoSelector, { once: true });
        } else {
          // Charger les voix au démarrage
          loadVoicesIntoSelector();
        }

        // Volume
        volumeSlider.addEventListener("input", (e) => {
          const val = e.target.value;
          volumeValue.textContent = val;
          setVolume(val / 100);
        });

        // Vitesse
        rateSlider.addEventListener("input", (e) => {
          const val = parseFloat(e.target.value);
          rateValue.textContent = val.toFixed(1);
          setRate(val);
        });

        // Tonalité
        pitchSlider.addEventListener("input", (e) => {
          const val = parseFloat(e.target.value);
          pitchValue.textContent = val.toFixed(1);
          setPitch(val);
        });

        // Voix
        voiceSelect.addEventListener("change", (e) => {
          const voices = window.speechSynthesis.getVoices();
          const frenchVoices = voices.filter(v => v.lang.startsWith('fr'));

          // Noms féminins à exclure pour prioriser les voix masculines
          const feminineNames = ['hortense', 'julie', 'denise', 'marie', 'celine', 'amelie', 'lea', 'pauline'];

          // Trier comme dans loadVoices
          const sortedVoices = frenchVoices.sort((a, b) => {
            const aName = a.name.toLowerCase();
            const bName = b.name.toLowerCase();
            const aIsFeminine = feminineNames.some(name => aName.includes(name));
            const bIsFeminine = feminineNames.some(name => bName.includes(name));

            if (aIsFeminine && !bIsFeminine) return 1;
            if (!aIsFeminine && bIsFeminine) return -1;

            const aIsGerardOnline = aName.includes('gerard') && aName.includes('online');
            const bIsGerardOnline = bName.includes('gerard') && bName.includes('online');
            if (aIsGerardOnline && !bIsGerardOnline) return -1;
            if (!aIsGerardOnline && bIsGerardOnline) return 1;

            const aIsOnline = aName.includes('online');
            const bIsOnline = bName.includes('online');
            if (aIsOnline && !bIsOnline) return -1;
            if (!aIsOnline && bIsOnline) return 1;

            return 0;
          });

          const selectedVoice = e.target.value ? sortedVoices[parseInt(e.target.value)] : null;
          setVoice(selectedVoice);
        });

        // Tester la voix
        testVoiceBtn.addEventListener("click", () => {
          speak("Bonjour, ceci est un test de la voix du chatbot.");
        });
      });
    </script>
  </body>
</html>
