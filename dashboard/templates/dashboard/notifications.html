{% extends 'dashboard/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">

  <!-- En-tête -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h4 class="fw-bold mb-1">
        <i class="bi bi-bell-fill text-primary me-2"></i> Centre de notifications
      </h4>
      <p class="text-muted mb-0 small">Gérez toutes vos notifications en un seul endroit</p>
    </div>
    <div class="d-flex gap-2">
      <button id="markAllReadGlobal" class="btn btn-outline-primary">
        <i class="bi bi-check-all me-2"></i>Tout marquer comme lu
      </button>
    </div>
  </div>

  <!-- Stats KPI -->
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <p class="text-muted mb-1 small fw-semibold text-uppercase">Total</p>
              <h2 class="fw-bold mb-0 text-primary">{{ total_notifications }}</h2>
            </div>
            <div class="icon-box bg-primary bg-opacity-10 text-primary">
              <i class="bi bi-bell fs-4"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <p class="text-muted mb-1 small fw-semibold text-uppercase">Non lues</p>
              <h2 class="fw-bold mb-0 text-warning">{{ unread_count }}</h2>
            </div>
            <div class="icon-box bg-warning bg-opacity-10 text-warning">
              <i class="bi bi-exclamation-circle fs-4"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <p class="text-muted mb-1 small fw-semibold text-uppercase">Lues</p>
              <h2 class="fw-bold mb-0 text-success">{{ read_count }}</h2>
            </div>
            <div class="icon-box bg-success bg-opacity-10 text-success">
              <i class="bi bi-check-circle fs-4"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtres -->
  <div class="card p-3 mb-4 shadow-sm">
    <div class="row g-3 align-items-end">
      <div class="col-md-4">
        <label class="form-label fw-semibold small">
          <i class="bi bi-funnel me-1"></i>Type de notification
        </label>
        <select id="filterType" class="form-select">
          <option value="">Tous les types</option>
          <option value="info" {% if filter_type == 'info' %}selected{% endif %}>Information</option>
          <option value="success" {% if filter_type == 'success' %}selected{% endif %}>Succès</option>
          <option value="warning" {% if filter_type == 'warning' %}selected{% endif %}>Avertissement</option>
          <option value="error" {% if filter_type == 'error' %}selected{% endif %}>Erreur</option>
          <option value="system" {% if filter_type == 'system' %}selected{% endif %}>Système</option>
          <option value="export" {% if filter_type == 'export' %}selected{% endif %}>Export</option>
          <option value="analytics" {% if filter_type == 'analytics' %}selected{% endif %}>Analytiques</option>
          <option value="user" {% if filter_type == 'user' %}selected{% endif %}>Utilisateur</option>
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label fw-semibold small">
          <i class="bi bi-toggle-on me-1"></i>Statut
        </label>
        <select id="filterStatus" class="form-select">
          <option value="">Tous les statuts</option>
          <option value="unread" {% if filter_status == 'unread' %}selected{% endif %}>Non lues</option>
          <option value="read" {% if filter_status == 'read' %}selected{% endif %}>Lues</option>
        </select>
      </div>

      <div class="col-md-4">
        <button id="applyFilters" class="btn btn-primary w-100">
          <i class="bi bi-search me-2"></i>Filtrer
        </button>
      </div>
    </div>
  </div>

  <!-- Liste des notifications -->
  <div class="card shadow-sm">
    <div class="card-body p-0">
      {% if page_obj %}
        <div class="notifications-list-page">
          {% for notification in page_obj %}
            <div class="notification-item-page {% if not notification.is_read %}unread{% endif %} p-4 border-bottom" data-id="{{ notification.id }}">
              <div class="d-flex gap-3">
                <!-- Icône -->
                <div class="notification-icon-large bg-{% if notification.notification_type == 'success' %}success{% elif notification.notification_type == 'warning' %}warning{% elif notification.notification_type == 'error' %}danger{% elif notification.notification_type == 'info' %}primary{% elif notification.notification_type == 'system' %}secondary{% elif notification.notification_type == 'export' %}info{% elif notification.notification_type == 'analytics' %}primary{% else %}dark{% endif %} bg-opacity-10 text-{% if notification.notification_type == 'success' %}success{% elif notification.notification_type == 'warning' %}warning{% elif notification.notification_type == 'error' %}danger{% elif notification.notification_type == 'info' %}primary{% elif notification.notification_type == 'system' %}secondary{% elif notification.notification_type == 'export' %}info{% elif notification.notification_type == 'analytics' %}primary{% else %}dark{% endif %} rounded-3 d-flex align-items-center justify-content-center flex-shrink-0"
                     style="width: 56px; height: 56px;">
                  <i class="{% if notification.icon %}{{ notification.icon }}{% else %}bi-bell-fill{% endif %} fs-4"></i>
                </div>

                <!-- Contenu -->
                <div class="flex-grow-1">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                      <h6 class="mb-1 fw-semibold">{{ notification.title }}</h6>
                      <span class="badge badge-{% if notification.notification_type == 'success' %}success{% elif notification.notification_type == 'warning' %}warning{% elif notification.notification_type == 'error' %}danger{% elif notification.notification_type == 'info' %}primary{% elif notification.notification_type == 'system' %}secondary{% elif notification.notification_type == 'export' %}info{% elif notification.notification_type == 'analytics' %}primary{% else %}dark{% endif %} me-2" style="font-size: 0.7rem;">
                        {{ notification.get_notification_type_display }}
                      </span>
                      <span class="badge bg-secondary" style="font-size: 0.7rem;">
                        {{ notification.get_priority_display }}
                      </span>
                    </div>
                    <div class="d-flex gap-2">
                      {% if not notification.is_read %}
                        <button class="btn btn-sm btn-outline-success mark-read-btn" data-id="{{ notification.id }}" title="Marquer comme lue">
                          <i class="bi bi-check"></i>
                        </button>
                      {% endif %}
                      <button class="btn btn-sm btn-outline-danger delete-btn" data-id="{{ notification.id }}" title="Supprimer">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>

                  <p class="text-muted mb-2" style="font-size: 0.9rem;">{{ notification.message }}</p>

                  <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                      <i class="bi bi-clock me-1"></i>
                      {{ notification.created_at|date:"d/m/Y à H:i" }}
                      {% if notification.is_read %}
                        <span class="text-success ms-2">
                          <i class="bi bi-check-all"></i> Lue le {{ notification.read_at|date:"d/m/Y à H:i" }}
                        </span>
                      {% endif %}
                    </small>

                    {% if notification.action_url %}
                      <a href="{{ notification.action_url }}" class="btn btn-sm btn-primary">
                        <i class="bi bi-arrow-right-circle me-1"></i>
                        {{ notification.action_label|default:"Voir" }}
                      </a>
                    {% endif %}
                  </div>

                  {% if not notification.is_read %}
                    <div class="notification-indicator"></div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
          <div class="p-4 border-top">
            <nav aria-label="Navigation des notifications">
              <ul class="pagination justify-content-center mb-0">
                {% if page_obj.has_previous %}
                  <li class="page-item">
                    <a class="page-link" href="?page=1{% if filter_type %}&type={{ filter_type }}{% endif %}{% if filter_status %}&status={{ filter_status }}{% endif %}">
                      <i class="bi bi-chevron-double-left"></i>
                    </a>
                  </li>
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if filter_type %}&type={{ filter_type }}{% endif %}{% if filter_status %}&status={{ filter_status }}{% endif %}">
                      <i class="bi bi-chevron-left"></i>
                    </a>
                  </li>
                {% endif %}

                <li class="page-item active">
                  <span class="page-link">
                    Page {{ page_obj.number }} sur {{ page_obj.paginator.num_pages }}
                  </span>
                </li>

                {% if page_obj.has_next %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if filter_type %}&type={{ filter_type }}{% endif %}{% if filter_status %}&status={{ filter_status }}{% endif %}">
                      <i class="bi bi-chevron-right"></i>
                    </a>
                  </li>
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if filter_type %}&type={{ filter_type }}{% endif %}{% if filter_status %}&status={{ filter_status }}{% endif %}">
                      <i class="bi bi-chevron-double-right"></i>
                    </a>
                  </li>
                {% endif %}
              </ul>
            </nav>
          </div>
        {% endif %}

      {% else %}
        <div class="text-center py-5">
          <i class="bi bi-bell-slash fs-1 text-muted mb-3 d-block"></i>
          <h5 class="text-muted">Aucune notification</h5>
          <p class="text-muted small">Vous n'avez aucune notification pour le moment.</p>
        </div>
      {% endif %}
    </div>
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Appliquer les filtres
  document.getElementById('applyFilters').addEventListener('click', () => {
    const type = document.getElementById('filterType').value;
    const status = document.getElementById('filterStatus').value;

    let url = '{% url "notifications" %}?';
    if (type) url += `type=${type}&`;
    if (status) url += `status=${status}`;

    window.location.href = url;
  });

  // Marquer toutes comme lues
  document.getElementById('markAllReadGlobal').addEventListener('click', () => {
    if (confirm('Marquer toutes les notifications comme lues ?')) {
      fetch('{% url "mark_all_notifications_read" %}', {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast('Toutes les notifications ont été marquées comme lues', 'success');
          setTimeout(() => location.reload(), 1000);
        }
      });
    }
  });

  // Marquer une notification comme lue
  document.querySelectorAll('.mark-read-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-id');
      fetch(`/dashboard/api/notifications/${id}/read/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast('Notification marquée comme lue', 'success');
          setTimeout(() => location.reload(), 500);
        }
      });
    });
  });

  // Supprimer une notification
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      if (confirm('Êtes-vous sûr de vouloir supprimer cette notification ?')) {
        const id = btn.getAttribute('data-id');
        fetch(`/dashboard/api/notifications/${id}/delete/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken')
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showToast('Notification supprimée', 'success');
            setTimeout(() => location.reload(), 500);
          }
        });
      }
    });
  });

  // Toast helper
  function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  // CSRF helper
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>

<style>
.notification-item-page {
  position: relative;
  transition: all var(--transition-base);
}

.notification-item-page.unread {
  background: linear-gradient(90deg, rgba(59, 130, 246, 0.03) 0%, transparent 100%);
  border-left: 3px solid var(--primary-500) !important;
}

.notification-item-page:hover {
  background: var(--bg-secondary);
}

.notification-icon-large {
  transition: all var(--transition-base);
}

.notification-item-page:hover .notification-icon-large {
  transform: scale(1.05) rotate(-5deg);
}

.notification-indicator {
  position: absolute;
  top: 1.5rem;
  right: 1.5rem;
  width: 10px;
  height: 10px;
  background: var(--primary-500);
  border-radius: 50%;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
    transform: scale(1);
  }
  50% {
    opacity: 0.7;
    transform: scale(1.1);
  }
}
</style>

{% endblock %}
